{% extends "dashboard/base.html" %}

{% block content %}
<style>
    .main-content { margin-left: 250px; padding: 30px; background-color: #f0f2f5; min-height: 100vh; }
    .chart-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; }
    
    /* Ocultar el checkbox original de Django */
    .hidden-delete { display: none; }
    
    /* Estilo para fila eliminada visualmente */
    .deleted-row { display: none; }

    @media (max-width: 768px) { .main-content { margin-left: 0; padding-top: 70px; } }
</style>

<div class="main-content">
    <div class="chart-card">
        <div class="border-bottom pb-3 mb-4 d-flex justify-content-between align-items-center">
            <h4 class="m-0 text-dark fw-bold"><i class="bi bi-cart-check text-primary me-2"></i> {{ titulo }}</h4>
            <a href="{% url 'dashboard:ventas' %}" class="btn btn-outline-secondary btn-sm">Volver</a>
        </div>

        <form method="post" id="ventaForm">
            {% csrf_token %}
            
            <div class="row g-3 mb-4 bg-light p-3 rounded border">
                <div class="col-md-5">
                    <label class="form-label fw-bold">Cliente</label>
                    {{ form.cliente }}
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">Estado Actual</label>
                    {{ form.estado }}
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Observación</label>
                    {{ form.observacion }}
                </div>
            </div>

            <h5 class="mb-3">Productos</h5>
            
            {{ formset.management_form }}

            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="tablaProductos">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60%;">Producto</th>
                            <th style="width: 25%;">Cantidad</th>
                            <th style="width: 15%;" class="text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form_detalle in formset %}
                        <tr class="form-row">
                            <td>
                                {% for hidden in form_detalle.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                {{ form_detalle.producto }}
                                {% if form_detalle.producto.errors %}
                                    <div class="text-danger small">{{ form_detalle.producto.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form_detalle.cantidad }}
                            </td>
                            <td class="text-center">
                                <span class="hidden-delete">{{ form_detalle.DELETE }}</span>
                                <button type="button" class="btn btn-outline-danger btn-sm btn-remove">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mb-4">
                <button type="button" class="btn btn-success btn-sm shadow-sm" id="add-product">
                    <i class="bi bi-plus-lg"></i> Agregar otro producto
                </button>
            </div>

            <hr>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary fw-bold px-4">
                    <i class="bi bi-save"></i> Guardar Venta
                </button>
            </div>
        </form>
    </div>
</div>

<div id="empty-form" style="display:none;">
    <table>
        <tr class="form-row">
            <td>{{ formset.empty_form.producto }}</td>
            <td>{{ formset.empty_form.cantidad }}</td>
            <td class="text-center">
                <span class="hidden-delete">{{ formset.empty_form.DELETE }}</span>
                <button type="button" class="btn btn-outline-danger btn-sm btn-remove">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.getElementById('add-product');
        const totalForms = document.getElementById('id_detalleventa_set-TOTAL_FORMS');
        const tableBody = document.querySelector('#tablaProductos tbody');
        
        addButton.addEventListener('click', function(e) {
            e.preventDefault();
            let formIdx = totalForms.value;
            const emptyFormHtml = document.getElementById('empty-form').innerHTML;
            const newRowHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newRowHtml;
            const newRow = tempDiv.querySelector('tr');
            tableBody.appendChild(newRow);
            totalForms.value = parseInt(formIdx) + 1;
        });

        tableBody.addEventListener('click', function(e) {
            if (e.target.closest('.btn-remove')) {
                const row = e.target.closest('tr');
                const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    row.style.display = 'none';
                } else {
                    row.remove();
                }
            }
        });
    });
</script>
{% endblock %}