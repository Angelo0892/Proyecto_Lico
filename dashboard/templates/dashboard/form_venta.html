{% extends "dashboard/base.html" %}

{% block content %}
<style>
.main-content {
    margin-left: 250px;
    padding: 30px;
    background-color: #f0f2f5;
    min-height: 100vh;
}
.chart-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.table-custom td, .table-custom th {
    vertical-align: middle;
}
@media (max-width:768px){
    .main-content{ margin-left:0; padding-top:70px; }
}
</style>

<div class="main-content">
<div class="chart-card">
<h4 class="mb-4"><i class="bi bi-cart-check text-primary"></i> Crear Venta</h4>


<form method="post" id="ventaForm" action="{% url 'dashboard:confirmar_venta' %}">
{% csrf_token %}

<!-- ================= CLIENTE ================= -->
<h5>Cliente</h5>
<input type="text" id="buscarCliente" class="form-control mb-2"
       placeholder="Buscar cliente por nombre, CI o NIT">
<ul class="list-group mb-3" id="resultadosClientes"></ul>

<div class="row mb-4">
    <div class="col-md-4">
        <label>Nombre</label>
        <input type="text" id="cliente_nombre" class="form-control" readonly>
    </div>
    <div class="col-md-4">
        <label>CI</label>
        <input type="text" id="cliente_ci" class="form-control" readonly>
    </div>
    <div class="col-md-4">
        <label>NIT</label>
        <input type="text" id="cliente_nit" class="form-control" readonly>
    </div>
</div>

<input type="hidden" name="cliente_id" id="cliente_id">

<!-- ================= PRODUCTOS ================= -->
<h5>Productos disponibles</h5>
<input type="text" id="buscarProducto" class="form-control mb-2"
       placeholder="Buscar productos">

<div class="table-responsive mb-3">
    <table class="table table-bordered table-hover table-custom" id="tablaProductos">
        <thead class="table-light">
            <tr>
                <th>Nombre</th>
                <th>Código</th>
                <th>Stock Actual</th>
                <th>Precio</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="productosBody"></tbody>
    </table>

    <nav>
        <ul class="pagination" id="paginacionProductos"></ul>
    </nav>
</div>

<!-- ================= CARRITO ================= -->
<h5>Carrito de venta</h5>
<div class="table-responsive mb-3">
    <table class="table table-bordered table-hover table-custom" id="tablaVenta">
        <thead class="table-light">
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="d-flex justify-content-end mb-4">
    <h5>Total: Bs <span id="totalCompra">0.00</span></h5>
</div>

<input type="hidden" name="total" id="totalHidden">

<button class="btn btn-primary">Guardar Venta</button>
</form>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

/* ================= CLIENTES ================= */
const buscarCliente = document.getElementById('buscarCliente');
const resultadosClientes = document.getElementById('resultadosClientes');

buscarCliente.addEventListener('input', () => {
    if (buscarCliente.value.length < 2) {
        resultadosClientes.innerHTML = '';
        return;
    }

    fetch("{% url 'dashboard:buscar_clientes' %}?q=" + buscarCliente.value)
    .then(res => res.json())
    .then(data => {
        resultadosClientes.innerHTML = '';
        data.forEach(c => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.textContent = `${c.nombre} - ${c.ci || c.nit}`;
            li.onclick = () => {
                cliente_nombre.value = c.nombre;
                cliente_ci.value = c.ci;
                cliente_nit.value = c.nit;
                cliente_id.value = c.id;
                resultadosClientes.innerHTML = '';
                buscarCliente.value = '';
            };
            resultadosClientes.appendChild(li);
        });
    });
});

/* ================= PRODUCTOS AJAX ================= */
const buscarProducto = document.getElementById('buscarProducto');
const productosBody = document.getElementById('productosBody');
const paginacionProductos = document.getElementById('paginacionProductos');

let query = '', page = 1;

function cargarProductos(){
    fetch(`{% url 'dashboard:buscar_productos_ajax' %}?q=${query}&page=${page}`)
    .then(res => res.json())
    .then(data => {
        productosBody.innerHTML = data.html;
        paginacionProductos.innerHTML = '';
        for(let i=1; i<=data.num_pages; i++){
            paginacionProductos.innerHTML += `
            <li class="page-item ${i===data.current_page?'active':''}">
                <a href="#" class="page-link" data-p="${i}">${i}</a>
            </li>`;
        }
    });
}

buscarProducto.addEventListener('input', () => {
    query = buscarProducto.value;
    page = 1;
    cargarProductos();
});

paginacionProductos.onclick = e => {
    if(e.target.dataset.p){
        e.preventDefault();
        page = e.target.dataset.p;
        cargarProductos();
    }
};

cargarProductos();

/* ================= CARRITO ================= */
const tablaVenta = document.querySelector('#tablaVenta tbody');
const totalCompra = document.getElementById('totalCompra');

function actualizarTotal(){
    let total = 0;
    tablaVenta.querySelectorAll('tr').forEach(r => {
        const c = r.querySelector('.cant').value;
        const p = r.querySelector('.precio').value;
        const t = c * p;
        r.querySelector('.total').textContent = t.toFixed(2);
        total += t;
    });
    totalCompra.textContent = total.toFixed(2);
}

document.getElementById('tablaProductos').onclick = e => {
    if(!e.target.classList.contains('btn-add')) return;

    const tr = e.target.closest('tr');
    const id = tr.dataset.id;

    if([...tablaVenta.children].some(r => r.dataset.id === id)) return;

    tablaVenta.insertAdjacentHTML('beforeend', `
    <tr data-id="${id}">
        <td>${tr.dataset.nombre}</td>
        <td><input type="number" class="form-control cant" value="1" min="1" ></td>
        <td><input type="number" class="form-control precio" value="${tr.dataset.precio}" min="0" step="0.01"></td>
        <td class="total">${tr.dataset.precio}</td>
        <td><button type="button" class="btn btn-sm btn-danger">✕</button></td>
    </tr>
    `);
    actualizarTotal();
};

tablaVenta.oninput = actualizarTotal;

tablaVenta.onclick = e => {
    if(e.target.tagName === 'BUTTON'){
        e.target.closest('tr').remove();
        actualizarTotal();
    }
};

/* ================= SUBMIT ================= */
document.getElementById('ventaForm').addEventListener('submit', function(){
    totalHidden.value = totalCompra.textContent;
    tablaVenta.querySelectorAll('tr').forEach(r => {
        this.insertAdjacentHTML('beforeend', `
        <input type="hidden" name="producto_id[]" value="${r.dataset.id}">
        <input type="hidden" name="cantidad[]" value="${r.querySelector('.cant').value}">
        <input type="hidden" name="precio[]" value="${r.querySelector('.precio').value}">
        `);
    });
});

document.getElementById('ventaForm').addEventListener('submit', function(e){
    if (parseFloat(totalCompra.textContent) <= 0) {
        e.preventDefault();
        alert("El total de la venta debe ser mayor a 0");
        return;
    }
});

});
</script>
{% endblock %}
