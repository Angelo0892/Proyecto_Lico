{% extends "dashboard/base.html" %}

{% block content %}

<style>
    .main-content { padding: 30px; background-color: #f0f2f5; min-height: 100vh; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; border-left: 5px solid transparent; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card.primary { border-left-color: #4e73df; }
    .stat-card.primary .icon { color: #4e73df; background: rgba(78, 115, 223, 0.1); }
    .stat-card.success { border-left-color: #1cc88a; }
    .stat-card.success .icon { color: #1cc88a; background: rgba(28, 200, 138, 0.1); }
    .stat-card.warning { border-left-color: #f6c23e; }
    .stat-card.warning .icon { color: #f6c23e; background: rgba(246, 194, 62, 0.1); }
    /* Cambio de color para la ganancia (Verde Oscuro) */
    .stat-card.profit { border-left-color: #198754; }
    .stat-card.profit .icon { color: #198754; background: rgba(25, 135, 84, 0.1); }
    
    .stat-card .icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; }
    .stat-label { font-size: 0.85rem; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: #333; margin-top: 5px; }
    .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; height: 100%; }
    .chart-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .table-custom thead th { background-color: #f8f9fc; border-bottom: 2px solid #e3e6f0; color: #666; font-weight: 600; font-size: 0.9rem; }
    .table-custom td { vertical-align: middle; font-size: 0.95rem; }
    .badge-stock-bajo { background-color: #ffebe6; color: #ff3b30; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
    @media (max-width: 768px) { .main-content { margin-left: 0; padding-top: 70px; } }
</style>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Dashboard Operativo</h2>
            <p class="text-muted">Estado del negocio - {{ fecha_actual|date:"d/m/Y" }}</p>
        </div>
        <div>
            <span class="text-muted">Usuario: <strong>{{ request.user.username }}</strong></span>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card primary">
                <div class="icon"><i class="bi bi-currency-dollar"></i></div>
                <div class="stat-label">Ventas del Mes</div>
                <div class="stat-value">${{ total_ventas_mes|floatformat:2 }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card success">
                <div class="icon"><i class="bi bi-graph-up-arrow"></i></div>
                <div class="stat-label">Ventas Hoy</div>
                <div class="stat-value">${{ total_ventas_hoy|floatformat:2 }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card warning">
                <div class="icon"><i class="bi bi-box"></i></div>
                <div class="stat-label">Total Productos</div>
                <div class="stat-value">{{ total_productos }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card profit">
                <div class="icon"><i class="bi bi-wallet2"></i></div>
                <div class="stat-label">Ganancia Estimada</div>
                <div class="stat-value text-success">+${{ ganancia_estimada|floatformat:2 }}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="chart-card">
                <h5 class="chart-title"><i class="bi bi-trophy text-warning"></i> Más Vendidos (Top 5)</h5>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Vendidos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos_top %}
                            <tr>
                                <td>
                                    <strong>{{ producto.producto__nombre }}</strong><br>
                                    <small class="text-muted">{{ producto.producto__codigo }}</small>
                                </td>
                                <td><span class="badge bg-light text-dark border">{{ producto.producto__categoria__nombre|default:"--" }}</span></td>
                                <td class="fw-bold">{{ producto.cantidad_vendida }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-muted">Sin movimientos</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="chart-card alert-stock">
                <h5 class="chart-title"><i class="bi bi-exclamation-triangle text-danger"></i> Stock Crítico</h5>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Stock</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos_bajo_stock %}
                            <tr>
                                <td>
                                    {{ producto.nombre }}
                                    <div class="small text-muted">{{ producto.categoria.nombre }}</div>
                                </td>
                                <td class="text-danger fw-bold">{{ producto.stock_actual }}</td>
                                <td>
                                    {% if producto.stock_actual == 0 %}
                                    <span class="badge badge-stock-bajo">Agotado</span>
                                    {% else %}
                                    <span class="badge badge-stock-bajo">Bajo</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-success"><i class="bi bi-check-circle"></i> Stock OK</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="chart-card">
                <h5 class="chart-title"><i class="bi bi-pie-chart text-info"></i> Ventas por Categoría</h5>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th>Categoría</th>
                                <th>Total Facturado</th>
                                <th style="width: 40%;">Barra</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cat in ventas_por_categoria %}
                            <tr>
                                <td><strong>{{ cat.producto__categoria__nombre }}</strong></td>
                                <td>${{ cat.total|floatformat:2 }}</td>
                                <td>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 70%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="chart-card">
                <h5 class="chart-title"><i class="bi bi-clock-history text-secondary"></i> Últimas Ventas</h5>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Vendedor</th>
                                <th>Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in ultimas_ventas %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ v.fecha|date:"H:i" }}</div>
                                    <small class="text-muted">{{ v.fecha|date:"d/m" }}</small>
                                </td>
                                <td>{{ v.usuario.nombre|default:"Admin" }}</td>
                                <td class="fw-bold">${{ v.total|floatformat:0 }}</td>
                                <td>
                                    {% if v.estado == 'PAGADO' %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    {% else %}
                                    <i class="bi bi-clock text-warning"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">Sin actividad reciente</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}